


# RAG  준비 단계 정리(Embedding -> VectorDB)

1. 문서 수집 → 전처리 & 청킹(300~800자 단위)
2. 임베딩 모델로 각 청크를 벡터화
3. 벡터DB에 저장 (텍스트 + 벡터 + 메타데이터)
4. 사용자가 질문 → 질문도 임베딩
5. 벡터DB에서 top-k 유사 문서 검색
6. 검색된 문서를 LLM에 컨텍스트로 전달 → 답변 생성


## 문서의 청킹 처리
```json
{"doc_id": "refund-001", "chk_no": 1, "title": "반품규정", "content": "우리 회사 반품 규정은 구매일로부터 7일 이내…", "updated_at": "2025-09-24T13:00:00", "source": "file"}
{"doc_id": "refund-001", "chk_no": 2, "title": "반품규정", "content": "고객은 반품 시 구매 영수증을 반드시 제출…", "updated_at": "2025-09-24T13:00:00", "source": "file"}
{"doc_id": "refund-001", "chk_no": 3, "title": "반품규정", "content": "반품 절차는 고객센터를 통해 접수 후…", "updated_at": "2025-09-24T13:00:00", "source": "file"}

```

```db
-- 부모: 문서
CREATE TABLE documents (
  doc_id        VARCHAR(100) PRIMARY KEY,
  title         VARCHAR(255) NOT NULL,
  source_type   ENUM('file','mysql','web') DEFAULT 'file',
  path_or_table VARCHAR(255),
  version       INT DEFAULT 1,
  updated_at    DATETIME,
  created_at    TIMESTAMP DEFAULT CURRENT_TIMESTAMP
) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4;

-- 중간: 섹션 (짧은 FAQ면 이 테이블 사용 안 해도 됨)
CREATE TABLE sections (
  section_id        BIGINT AUTO_INCREMENT PRIMARY KEY,
  doc_id            VARCHAR(100) NOT NULL,
  parent_section_id BIGINT NULL,
  title             VARCHAR(255),
  ordinal           INT NOT NULL,   -- 문서 내 섹션 순서
  CONSTRAINT fk_sections_docs
    FOREIGN KEY (doc_id) REFERENCES documents(doc_id) ON DELETE CASCADE,
  CONSTRAINT fk_sections_parent
    FOREIGN KEY (parent_section_id) REFERENCES sections(section_id) ON DELETE CASCADE,
  UNIQUE (doc_id, ordinal)
) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4;

-- 자식: 청크 (섹션이 없으면 section_id = NULL)
CREATE TABLE chunks (
  id          BIGINT AUTO_INCREMENT PRIMARY KEY,
  doc_id      VARCHAR(100) NOT NULL,
  section_id  BIGINT NULL,
  chk_no      INT NOT NULL,
  content     TEXT NOT NULL,
  token_len   INT NULL,
  checksum    CHAR(32) NULL,
  created_at  TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
  CONSTRAINT fk_chunks_docs
    FOREIGN KEY (doc_id) REFERENCES documents(doc_id) ON DELETE CASCADE,
  CONSTRAINT fk_chunks_sections
    FOREIGN KEY (section_id) REFERENCES sections(section_id) ON DELETE SET NULL,
  UNIQUE (doc_id, chk_no)
);
CREATE INDEX ix_chunks_doc_section ON chunks(doc_id, section_id, chk_no);

```


